name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test -- --run

      - name: Build frontend (test)
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:8787/api' }}

  deploy-workers:
    name: Deploy Workers
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy Workers
        run: npm run deploy:workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Run migrations
        run: npx wrangler d1 migrations apply amei-beauty-db --config wrangler.workers.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  deploy-pages:
    name: Deploy Pages
    runs-on: ubuntu-latest
    needs: [test, deploy-workers]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify VITE_API_URL secret
        run: |
          if [ -z "${{ secrets.VITE_API_URL }}" ]; then
            echo "::error::VITE_API_URL secret is not set in GitHub Actions secrets!"
            echo "Please add VITE_API_URL secret in: Settings > Secrets and variables > Actions"
            echo "Format: https://amei-beauty-api.YOUR_SUBDOMAIN.workers.dev/api"
            exit 1
          else
            # Check for leading/trailing whitespace
            API_URL="${{ secrets.VITE_API_URL }}"
            TRIMMED_URL=$(echo "$API_URL" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            if [ "$API_URL" != "$TRIMMED_URL" ]; then
              echo "::error::VITE_API_URL has leading or trailing whitespace!"
              echo "Original: '$API_URL'"
              echo "Trimmed:  '$TRIMMED_URL'"
              echo "Please update the secret to remove spaces. This can cause API calls to fail."
              exit 1
            fi
            
            echo "✅ VITE_API_URL is set"
            echo "Value: $API_URL"
            # Validate URL format
            if [[ "$API_URL" == *"localhost"* ]]; then
              echo "::error::VITE_API_URL contains 'localhost' - this won't work in production!"
              echo "Please set it to your Workers URL: https://amei-beauty-api.adsventures.workers.dev/api"
              exit 1
            fi
            if [[ "$API_URL" != *"workers.dev"* ]] && [[ "$API_URL" != *"amei.beauty"* ]]; then
              echo "::warning::VITE_API_URL doesn't look like a production URL"
              echo "Expected format: https://amei-beauty-api.adsventures.workers.dev/api"
            fi
            if [[ "$API_URL" != */api ]]; then
              echo "::warning::VITE_API_URL should end with /api"
            fi
          fi

      - name: Build frontend
        run: |
          # Trim whitespace from VITE_API_URL to prevent issues
          API_URL="${{ secrets.VITE_API_URL }}"
          TRIMMED_API_URL=$(echo "$API_URL" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Fail if VITE_API_URL is empty or still localhost after trimming
          if [ -z "$TRIMMED_API_URL" ]; then
            echo "::error::VITE_API_URL is empty! Please set it in GitHub Actions secrets."
            echo "Go to: Settings > Secrets and variables > Actions > New repository secret"
            echo "Name: VITE_API_URL"
            echo "Value: https://amei-beauty-api.adsventures.workers.dev/api"
            exit 1
          fi
          
          if [[ "$TRIMMED_API_URL" == *"localhost"* ]]; then
            echo "::error::VITE_API_URL contains 'localhost' after trimming: $TRIMMED_API_URL"
            echo "Please set VITE_API_URL to your production Workers URL in GitHub Actions secrets."
            echo "Expected: https://amei-beauty-api.adsventures.workers.dev/api"
            exit 1
          fi
          
          echo "Building with VITE_API_URL=$TRIMMED_API_URL"
          # Export trimmed value - this will be used by Vite during build
          export VITE_API_URL="$TRIMMED_API_URL"
          npm run build
          echo "Build completed. Checking if API URL was embedded correctly..."
          # Check if localhost appears in built files (should not in production)
          if grep -r "localhost:8787" dist/ 2>/dev/null; then
            echo "::error::Build still contains localhost URLs! VITE_API_URL may not have been applied correctly."
            echo "Expected: $TRIMMED_API_URL"
            echo "This usually means VITE_API_URL was not set correctly in GitHub Actions secrets."
            exit 1
          fi
          echo "✅ Build verified: No localhost URLs found in dist/"
          echo "✅ API URL embedded: $TRIMMED_API_URL"

      - name: Deploy to Cloudflare Pages
        run: npm run deploy:pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

